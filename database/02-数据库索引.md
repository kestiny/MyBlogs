# 1 数据库索引
什么是索引？索引是为了加速对表中数据行的检索而创建的一种分散的存储结构。索引是针对表而建立的，它是由数据页面以外的索引页面组成的，每个索引页面中的行都会含有逻辑指针，以便加速检索物理数据。简单说来，索引就相当于一本书的目录。

## 1.1 索引的存储
索引的存储有多种不同的方式，常用的有哈希表、有序数组和搜索树等。哈希表适用于只有等值查询的场景，比如NoSQL数据库引擎大多采用这种方式。有序数据使用于静态存储类的场景，对应等值查询和范围查询非常合适。

在MySQL中，索引是在存储引擎层实现的，因此也就没有统一的索引标准，不同的存储引擎实现不太一样。MySQL中常用的存储引擎InnoDB中，索引存储使用的是搜索树，准确的说是B+树。
B+树的数据只会存储在叶子节点中，其他节点不会存储数据。

## 1.2 主键索引与普通索引
主键索引的叶子节点存储的整行数据。在InnoDB中，主键索引也被称为聚簇索引。
普通索引，也即非主键索引的叶子节点存储的是主键的值。在InnoDB中，非主键索引也称为二级索引。
主键索引的查询，只需要搜索主键对应的B+树；普通索引的查询，需要先搜索普通索引对应的B+树，找到主键索引值，在通过主键索引值搜索主键B+树，这个过程称为回表。也就是说，普通索引的查询需要多扫描一颗索引树。
```sql
mysql> create table T(
id int primary key, 
age int not null, 
name varchar(16),
index (age))engine=InnoDB;
```
比如在表T中有以下查询语句：
- select * from T where id=5，即主键查询方式，则只需要搜索id这棵B+树；
- select * from T where age=5，即普通索引查询方式，则需要先搜索age索引树，得到主键id的值，再到id索引树搜索一次。

## 1.3 索引维护
B+树的存在是为了维护索引的有序性，因此在数据表进行插入是，需要对索引树进行维护。有几种情况：
- 插入在最后，则直接增加一个节点；
- 插入在中间，则需要先挪动插入之后的数据，空出位置给插入的数据；
- 插入时，所在的数据页已经满了，则需要先申请一个新的数据页，在挪动部分数据到新的数据页。这被称为页分裂。这种情况是性能最低的。

## 1.4 索引覆盖
假设有语句"select * from T where age between 3 and 5"，他的执行流程是这样的：
1. 在age索引树上找到age=3这条记录，取得主键id的值；
2. 再到id索引树查到相应的id值对应的记录值；
3. 在age树上找到下一个值，判断是否满足条件；
4. 满足条件，则取得主键索引id值，然后重复步骤2；
5. 不满足条件，循环结束；

这条查询语句所需要的数据只在主键索引上，所以不得不做回表操作。
假设有另外的语句"select id from T where age between 3 and 5"，这时只需要查询id的值，而id的值已经在age索引树上了，因此可以直接得到查询结果，不需要回表。换言之，在此查询中，索引age已经覆盖了我们的查询需求，因此称之为覆盖索引。
覆盖索引可以减少树的搜索次数，显著的提升查询效率，因此这是一个比较常用的性能优化手段。
