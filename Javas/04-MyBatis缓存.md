# MyBatis的缓存

## 缓存介绍
### 为什么使用缓存
&emsp;&emsp;在数据库使用的过程中，有一些数据的查询频次远大于修改，甚至是不会进行修改的，如果将用户的这部分数据放在缓存（内存）中，用户去查询数据就不用从磁盘上(关系型数据库数据文件)查询，从缓存中查询，从而提高查询效率，解决了高并发系统的性能问题。因此，缓存是非常有必要的，但是也要注意，对于使用频次不高，或者经常修改的数据进行缓存也会加大系统开销。

## MyBatis缓存
&emsp;&emsp;MyBatis包含一个非常强大的查询缓存特性，它可以非常方便地定制和配置缓存。MyBatis默认使用了两级缓存：**一级缓存**和**二级缓存**：
- 默认情况下，MyBatis只开启了一级缓存，也称之为本地缓存；
- 二级缓存需要手动开启和配置，基于namespace级别的；
- 二级缓存可以自定义，需要实现MyBatis的Cache缓存接口。

### 一级缓存
&emsp;&emsp;一级缓存是默认开启的，并且无法关闭。一级缓存是SqlSession级别的，可以通过连续调用同一个查询多次来验证，只有第一次会打印出sql语句。

#### 失败的请况
- SqlSession不同，每个SqlSession都是单独缓存的；
- SqlSession相同，但是在两次查询中进行了insert、delete或者update操作，因为这些操作会影响数据，因此会重新进行缓存；

#### 一级缓存清除方式
手动清除缓存，MyBatis提供了清除一级缓存的方法SqlSession.clearCache();

### 二级缓存
&emsp;&emsp;二级缓存也叫全局缓存，是为弥补一级缓存只存在于会话(SqlSession)级别的二产生的。二级缓存基于namespace，每一个命令空间下对应一个二级缓存。

#### 二级缓存的实现机制
- 会话的一条查询语句，其缓存会存放在会话中；
- 若此会话关闭，则会话中的一级缓存会存放到二级缓存中；
- 新的会话查询，就可以从二级缓存中拿到缓存数据。

#### 二级缓存使用方法
1. 开启全局缓存配置，文件“mybatis-config.xml”

    ```<setting name="cacheEnabled" value="true"/>```

2. 使用默认的二级缓存机制，只需要在mapper.xml文件中添加配置

    ```<cache/>```

- 映射语句文件中的所有 select 语句的结果将会被缓存。
- 映射语句文件中的所有 insert、update 和 delete 语句会刷新缓存。
- 缓存会使用最近最少使用算法（LRU, Least Recently Used）算法来清除不需要的缓存。
- 缓存不会定时进行刷新（也就是说，没有刷新间隔）。
- 缓存会保存列表或对象（无论查询方法返回哪种）的 1024 个引用。
- 缓存会被视为读/写缓存，这意味着获取到的对象并不是共享的，可以安全地被调用者修改，而不干扰其他调用者或线程所做的潜在修改。

3. 使用自定义配置的二级缓存，需要在mapper.xml中配置
    ```
    <cache
    eviction="FIFO"
    flushInterval="60000"
    size="512"
    readOnly="true"/>
    ```

- eviction：缓存清楚策略
    + LRU – 最近最少使用：移除最长时间不被使用的对象，这是默认的清除策略。
    + FIFO – 先进先出：按对象进入缓存的顺序来移除它们。
    + SOFT – 软引用：基于垃圾回收器状态和软引用规则移除对象。
    + WEAK – 弱引用：更积极地基于垃圾收集器状态和弱引用规则移除对象。
- flushInterval:刷新间隔，属性可以被设置为任意的正整数，设置的值应该是一个以毫秒为单位的合理时间量。 默认情况是不设置，也就是没有刷新间隔，缓存仅仅会在调用语句时刷新
- size（引用数目）属性可以被设置为任意正整数，要注意欲缓存对象的大小和运行环境中可用的内存资源。默认值是 1024。
- readOnly（只读）属性可以被设置为 true 或 false。只读的缓存会给所有调用者返回缓存对象的相同实例。 因此这些对象不能被修改。这就提供了可观的性能提升。而可读写的缓存会（通过序列化）返回缓存对象的拷贝。 速度上会慢一些，但是更安全，因此默认值是 false。

4. 使用自定义缓存

&emsp;&emsp;除了上述自定义缓存的方式，MyBatis也允许通过实现完全自定义的缓存，或为其他第三方缓存方案创建适配器，来完全覆盖缓存行为。